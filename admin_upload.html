<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VMCTK â€“ Add New Book</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-800">
  <div class="min-h-screen max-w-3xl mx-auto px-4 py-6">
    <header class="mb-6 flex items-center justify-between gap-3 flex-wrap">
      <div>
        <h1 id="pageHeading" class="text-2xl font-bold text-slate-900">Add New Book</h1>
        <p id="pageSubtitle" class="text-sm text-slate-500">
          This form will append a new row to <strong>Sheet1</strong> in your Google Sheet.
        </p>
      </div>

      <div class="flex items-center gap-3 text-sm">
        <!-- Language toggle -->
        <div class="inline-flex items-center rounded-full border border-slate-300 bg-slate-200 overflow-hidden">
          <button
            id="uploadEnBtn"
            type="button"
            class="px-3 py-1 text-xs flex items-center gap-1 bg-white text-slate-800 font-semibold"
          >
            <span>ğŸ‡¬ğŸ‡§</span><span>EN</span>
          </button>
          <button
            id="uploadKhBtn"
            type="button"
            class="px-3 py-1 text-xs flex items-center gap-1 text-slate-600"
          >
            <span>ğŸ‡°ğŸ‡­</span><span>KH</span>
          </button>
        </div>

        <a id="dashboardLink" href="admin.html" class="text-blue-600 hover:underline">
          ğŸ“Š Dashboard
        </a>
        <a id="backToLibraryLink" href="index.html" class="text-blue-600 hover:underline">
          â† Back to Library
        </a>
      </div>
    </header>

    <section class="bg-white rounded-xl shadow p-5">
      <form id="bookForm" class="space-y-4">
        <!-- Admin key -->
        <div>
          <label
            id="labelAdminKey"
            class="block text-xs font-semibold text-slate-600 mb-1"
            for="adminKey"
          >
            Admin key <span class="text-red-500">*</span>
          </label>
          <input
            id="adminKey"
            name="adminKey"
            type="password"
            required
            class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200"
            placeholder="Enter the same ADMIN_KEY as in Apps Script"
          />
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label
              id="labelTitle"
              class="block text-xs font-semibold text-slate-600 mb-1"
              for="title"
            >
              Title <span class="text-red-500">*</span>
            </label>
            <input
              id="title"
              name="title"
              type="text"
              required
              class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200"
              placeholder="Book title"
            />
          </div>

          <div>
            <label
              id="labelAuthor"
              class="block text-xs font-semibold text-slate-600 mb-1"
              for="author"
            >
              Author
            </label>
            <input
              id="author"
              name="author"
              type="text"
              class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200"
              placeholder="Author name"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label
              id="labelLanguage"
              class="block text-xs font-semibold text-slate-600 mb-1"
              for="language"
            >
              Language
            </label>
            <select
              id="language"
              name="language"
              class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200"
            >
              <option id="optLangDefault" value="">â€“ Select â€“</option>
              <option id="optLangKhmer" value="Khmer">Khmer</option>
              <option id="optLangEnglish" value="English">English</option>
              <option id="optLangBilingual" value="Bilingual">Bilingual</option>
              <option id="optLangOther" value="Other">Other</option>
            </select>
          </div>

          <div>
            <label
              id="labelCategory"
              class="block text-xs font-semibold text-slate-600 mb-1"
              for="category"
            >
              Category
            </label>
            <input
              id="category"
              name="category"
              type="text"
              class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200"
              placeholder="e.g. Novel, Education, Children"
            />
          </div>
        </div>

        <!-- PDF link -->
        <div>
          <label
            id="labelPdfLink"
            class="block text-xs font-semibold text-slate-600 mb-1"
            for="pdfLink"
          >
            PDF Link (Google Drive) <span class="text-red-500">*</span>
          </label>
          <input
            id="pdfLink"
            name="pdfLink"
            type="url"
            required
            class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200"
            placeholder="https://drive.google.com/file/d/â€¦"
          />
          <p id="helpPdfLink" class="text-xs text-slate-500 mt-1">
            Upload the PDF to Google Drive, click â€œShare â†’ Anyone with the link â†’ Viewerâ€, then paste the link here.
          </p>
        </div>

        <!-- Cover link -->
        <div>
          <label
            id="labelCoverOriginal"
            class="block text-xs font-semibold text-slate-600 mb-1"
            for="coverOriginal"
          >
            Cover image link (Google Drive)
          </label>
          <input
            id="coverOriginal"
            name="coverOriginal"
            type="url"
            class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200"
            placeholder="https://drive.google.com/file/d/â€¦"
          />
          <p id="helpCoverOriginal" class="text-xs text-slate-500 mt-1">
            The script will auto-generate a thumbnail URL for <strong>Cover Link</strong> using this file.
          </p>
        </div>

        <!-- Featured + description -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label
              id="labelFeatured"
              class="block text-xs font-semibold text-slate-600 mb-1"
              for="featured"
            >
              Featured
            </label>
            <select
              id="featured"
              name="featured"
              class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200"
            >
              <option id="optFeaturedNo" value="">No</option>
              <option id="optFeaturedYes" value="Yes">Yes</option>
            </select>
          </div>

          <div>
            <label
              id="labelDescription"
              class="block text-xs font-semibold text-slate-600 mb-1"
              for="description"
            >
              Short description
            </label>
            <textarea
              id="description"
              name="description"
              rows="2"
              class="w-full border rounded px-3 py-2 text-sm resize-none focus:outline-none focus:ring focus:ring-blue-200"
              placeholder="Optional short description..."
            ></textarea>
          </div>
        </div>

        <div class="pt-2 flex items-center gap-3">
          <button
            id="submitBtn"
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded shadow hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            Add book
          </button>
          <!-- class will be set dynamically (grey / green / red) -->
          <span id="statusMsg" class="text-xs"></span>
        </div>
      </form>
    </section>
  </div>

  <script>
    // ğŸ”— Your Apps Script Web App URL (same one used in index.html & admin.html)
    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbwah-ItVQyz8--t-qJRTFxkuzM5Yh-KQMyvcV-bcPzOZf6jU_9oWKKMurCyoUmqYBAM/exec";

    /*************** LANGUAGE TEXTS ***************/
    const uploadText = {
      en: {
        pageTitle: "VMCTK â€“ Add New Book",
        heading: "Add New Book",
        subtitle: 'This form will append a new row to "Sheet1" in your Google Sheet.',
        dashboardLink: "ğŸ“Š Dashboard",
        backToLibrary: "â† Back to Library",

        adminKeyLabel: "Admin key *",
        adminKeyPlaceholder: "Enter the same ADMIN_KEY as in Apps Script",

        titleLabel: "Title *",
        titlePlaceholder: "Book title",

        authorLabel: "Author",
        authorPlaceholder: "Author name",

        languageLabel: "Language",
        languageDefault: "â€“ Select â€“",
        languageKhmer: "Khmer",
        languageEnglish: "English",
        languageBilingual: "Bilingual",
        languageOther: "Other",

        categoryLabel: "Category",
        categoryPlaceholder: "e.g. Novel, Education, Children",

        pdfLabel: "PDF Link (Google Drive) *",
        pdfPlaceholder: "https://drive.google.com/file/d/â€¦",
        pdfHelp:
          "Upload the PDF to Google Drive, click â€œShare â†’ Anyone with the link â†’ Viewerâ€, then paste the link here.",

        coverOriginalLabel: "Cover image link (Google Drive)",
        coverOriginalPlaceholder: "https://drive.google.com/file/d/â€¦",
        coverOriginalHelp:
          "The script will auto-generate a thumbnail URL for Cover Link using this file.",

        featuredLabel: "Featured",
        featuredNo: "No",
        featuredYes: "Yes",

        descriptionLabel: "Short description",
        descriptionPlaceholder: "Optional short description...",

        buttonAdd: "Add book",
        buttonAdding: "Addingâ€¦",

        statusNonJson: "Server returned a non-JSON response. Check console.",
        statusErrorPrefix: "Error: ",
        statusUnknownError: "Unknown error",
        statusBookAddedPrefix: "âœ… Book added with ID ",
        statusNetworkError: "Network error while adding book.",
        statusInvalidKey: "Invalid admin key. Please check your password."
      },
      kh: {
        pageTitle: "VMCTK â€“ á”á“áŸ’ááŸ‚á˜áŸáŸ€áœá—áŸ…ááŸ’á˜á¸",
        heading: "á”á“áŸ’ááŸ‚á˜áŸáŸ€áœá—áŸ…ááŸ’á˜á¸",
        subtitle:
          "á‘á˜áŸ’ášá„áŸ‹á“áŸáŸ‡á“á¹á„á”á“áŸ’ááŸ‚á˜á‡á½ášáŠáŸá€ááŸ’á˜á¸á‘áŸ… \"Sheet1\" á€áŸ’á“á»á„ Google Sheet ášá”áŸáŸ‹á¢áŸ’á“á€áŸ”",
        dashboardLink: "ğŸ“Š á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„",
        backToLibrary: "â† ááŸ’ášá›á”áŸ‹á‘áŸ…á”ááŸ’áá¶á›áŸá™",

        adminKeyLabel: "á›áŸááŸá˜áŸ’á„á¶ááŸ‹á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ *",
        adminKeyPlaceholder: "á”á‰áŸ’á…á¼á› ADMIN_KEY áŠá¼á…á€áŸ’á“á»á„ Apps Script",

        titleLabel: "á…áŸ†áá„á‡á¾á„ *",
        titlePlaceholder: "á…áŸ†áá„á‡á¾á„áŸáŸ€áœá—áŸ…",

        authorLabel: "á¢áŸ’á“á€á“á·á–á“áŸ’á’",
        authorPlaceholder: "áˆáŸ’á˜áŸ„áŸ‡á¢áŸ’á“á€á“á·á–á“áŸ’á’",

        languageLabel: "á—á¶áŸá¶",
        languageDefault: "â€“ á‡áŸ’ášá¾áŸ â€“",
        languageKhmer: "ááŸ’á˜áŸ‚áš",
        languageEnglish: "á¢á„áŸ‹á‚áŸ’á›áŸáŸ",
        languageBilingual: "á–á¸ášá—á¶áŸá¶",
        languageOther: "á•áŸ’áŸáŸá„á‘áŸ€á",

        categoryLabel: "á”áŸ’ášá—áŸá‘",
        categoryPlaceholder: "á§. á“á¶áœá›, á¢á”áŸ‹ášáŸ†, á€á»á˜á¶áš",

        pdfLabel: "ááŸ†áášá—áŸ’á‡á¶á”áŸ‹ PDF (Google Drive) *",
        pdfPlaceholder: "https://drive.google.com/file/d/â€¦",
        pdfHelp:
          "á•áŸ’á‘á»á€á¯á€áŸá¶áš PDF á‘áŸ… Google Drive á”á“áŸ’á‘á¶á”áŸ‹á˜á€á…á»á… â€œShare â†’ Anyone with the link â†’ Viewerâ€ á á¾á™á”á·á‘á—áŸ’á‡á¶á”áŸ‹ááŸ†áá“áŸ…á‘á¸á“áŸáŸ‡áŸ”",

        coverOriginalLabel: "ááŸ†áášá‚á˜áŸ’ášá”áŸáŸ€áœá—áŸ… (Google Drive)",
        coverOriginalPlaceholder: "https://drive.google.com/file/d/â€¦",
        coverOriginalHelp:
          "Script á“á¹á„á”á„áŸ’á€á¾á URL ášá¼á”áá¼á…áŸá˜áŸ’ášá¶á”áŸ‹ Cover Link áŠáŸ„á™áŸáŸ’áœáŸá™á”áŸ’ášáœááŸ’áá·á–á¸á¯á€áŸá¶ášá“áŸáŸ‡áŸ”",

        featuredLabel: "áŸáŸ€áœá—áŸ…á–á·áŸáŸáŸ",
        featuredNo: "á‘áŸ",
        featuredYes: "á”á¶á‘/á…á¶áŸ",

        descriptionLabel: "á–ááŸŒá“á¶ááŸ’á›á¸",
        descriptionPlaceholder: "á–ááŸŒá“á¶ááŸ’á›á¸á¢áŸ†á–á¸áŸáŸ€áœá—áŸ… (á˜á·á“á…á¶áŸ†á”á¶á…áŸ‹)...",

        buttonAdd: "á”á“áŸ’ááŸ‚á˜áŸáŸ€áœá—áŸ…",
        buttonAdding: "á€áŸ†á–á»á„á”á“áŸ’ááŸ‚á˜...",

        statusNonJson: "á˜áŸ‰á¶áŸáŸŠá¸á“á˜áŸá˜á·á“á†áŸ’á›á¾á™áá”á‡á¶ JSON á‘áŸáŸ” áŸá¼á˜á–á·á“á·ááŸ’á™ ConsoleáŸ”",
        statusErrorPrefix: "á€áŸ†á á»áŸáŸ– ",
        statusUnknownError: "á˜á·á“áŠá¹á„á˜á¼á›á áŸáá»",
        statusBookAddedPrefix: "âœ… á”á¶á“á”á“áŸ’ááŸ‚á˜áŸáŸ€áœá—áŸ…á‡á¶á˜á½á™ ID ",
        statusNetworkError: "á”á‰áŸ’á á¶á”ááŸ’áŠá¶á‰á–áŸá›á”á“áŸ’ááŸ‚á˜áŸáŸ€áœá—áŸ…áŸ”",
        statusInvalidKey: "á›áŸááŸá˜áŸ’á„á¶ááŸ‹á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœá‘áŸáŸ” áŸá¼á˜á–á·á“á·ááŸ’á™á˜áŸ’áá„á‘áŸ€ááŸ”"
      }
    };

    // Share the same key with admin.html so language stays in sync
    let currentLang = localStorage.getItem("vmctk_admin_lang") || "en";

    function applyUploadLanguage() {
      const t = uploadText[currentLang] || uploadText.en;

      // <title>
      document.title = t.pageTitle;

      // Header
      const headingEl = document.getElementById("pageHeading");
      const subtitleEl = document.getElementById("pageSubtitle");
      const dashboardLink = document.getElementById("dashboardLink");
      const backToLibrary = document.getElementById("backToLibraryLink");

      if (headingEl) headingEl.textContent = t.heading;
      if (subtitleEl) subtitleEl.textContent = t.subtitle;
      if (dashboardLink) dashboardLink.textContent = t.dashboardLink;
      if (backToLibrary) backToLibrary.textContent = t.backToLibrary;

      // Labels
      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };

      setText("labelAdminKey", t.adminKeyLabel);
      setText("labelTitle", t.titleLabel);
      setText("labelAuthor", t.authorLabel);
      setText("labelLanguage", t.languageLabel);
      setText("labelCategory", t.categoryLabel);
      setText("labelPdfLink", t.pdfLabel);
      setText("labelCoverOriginal", t.coverOriginalLabel);
      setText("labelFeatured", t.featuredLabel);
      setText("labelDescription", t.descriptionLabel);

      // Placeholders & help texts
      const adminKeyInput = document.getElementById("adminKey");
      const titleInput = document.getElementById("title");
      const authorInput = document.getElementById("author");
      const categoryInput = document.getElementById("category");
      const pdfInput = document.getElementById("pdfLink");
      const coverOrigInput = document.getElementById("coverOriginal");
      const descriptionInput = document.getElementById("description");

      if (adminKeyInput) adminKeyInput.placeholder = t.adminKeyPlaceholder;
      if (titleInput) titleInput.placeholder = t.titlePlaceholder;
      if (authorInput) authorInput.placeholder = t.authorPlaceholder;
      if (categoryInput) categoryInput.placeholder = t.categoryPlaceholder;
      if (pdfInput) pdfInput.placeholder = t.pdfPlaceholder;
      if (coverOrigInput) coverOrigInput.placeholder = t.coverOriginalPlaceholder;
      if (descriptionInput) descriptionInput.placeholder = t.descriptionPlaceholder;

      const helpPdf = document.getElementById("helpPdfLink");
      const helpCover = document.getElementById("helpCoverOriginal");
      if (helpPdf) helpPdf.textContent = t.pdfHelp;
      if (helpCover) helpCover.textContent = t.coverOriginalHelp;

      // Language select options
      const optDefault = document.getElementById("optLangDefault");
      const optKhmer = document.getElementById("optLangKhmer");
      const optEnglish = document.getElementById("optLangEnglish");
      const optBilingual = document.getElementById("optLangBilingual");
      const optOther = document.getElementById("optLangOther");

      if (optDefault) optDefault.textContent = t.languageDefault;
      if (optKhmer) optKhmer.textContent = t.languageKhmer;
      if (optEnglish) optEnglish.textContent = t.languageEnglish;
      if (optBilingual) optBilingual.textContent = t.languageBilingual;
      if (optOther) optOther.textContent = t.languageOther;

      // Featured options
      const optFeatNo = document.getElementById("optFeaturedNo");
      const optFeatYes = document.getElementById("optFeaturedYes");
      if (optFeatNo) optFeatNo.textContent = t.featuredNo;
      if (optFeatYes) optFeatYes.textContent = t.featuredYes;

      // Button label
      const submitBtn = document.getElementById("submitBtn");
      if (submitBtn) submitBtn.textContent = t.buttonAdd;

      // Language toggle visuals
      const enBtn = document.getElementById("uploadEnBtn");
      const khBtn = document.getElementById("uploadKhBtn");
      if (enBtn && khBtn) {
        if (currentLang === "en") {
          enBtn.classList.add("bg-white", "text-slate-800", "font-semibold");
          khBtn.classList.remove("bg-white", "text-slate-800", "font-semibold");
          khBtn.classList.add("text-slate-600");
        } else {
          khBtn.classList.add("bg-white", "text-slate-800", "font-semibold");
          enBtn.classList.remove("bg-white", "text-slate-800", "font-semibold");
          enBtn.classList.add("text-slate-600");
        }
      }
    }

    /*************** FORM SUBMIT ***************/
    const form = document.getElementById("bookForm");
    const submitBtn = document.getElementById("submitBtn");
    const statusMsg = document.getElementById("statusMsg");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const t = uploadText[currentLang] || uploadText.en;

      // Reset status style to neutral grey
      statusMsg.className = "text-xs text-slate-500";
      statusMsg.textContent = "";
      submitBtn.disabled = true;
      submitBtn.textContent = t.buttonAdding;

      const formData = new FormData(form);

      // NOTE: this type matches Apps Script: 'admin-add-book'
      formData.append("type", "admin-add-book");

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams(formData)
        });

        let data;
        try {
          data = await res.json();
        } catch (parseErr) {
          const text = await res.text();
          console.error("Non-JSON response:", text);
          statusMsg.className = "text-xs text-red-600";
          statusMsg.textContent = t.statusNonJson;
          return;
        }

        if (!data.success) {
          console.error("Add book error:", data);
          statusMsg.className = "text-xs text-red-600";

          if (data.error === "Invalid admin key") {
            // Special friendly message for wrong admin password
            statusMsg.textContent = t.statusInvalidKey;
          } else {
            const msg =
              t.statusErrorPrefix + (data.error || t.statusUnknownError);
            statusMsg.textContent = msg;
          }
          return;
        }

        // Prefer data.id, but also support data.book?.id if your script returns that
        const newId = data.id ?? (data.book && data.book.id) ?? "";
        statusMsg.className = "text-xs text-green-600";
        statusMsg.textContent = t.statusBookAddedPrefix + newId;
        form.reset();
      } catch (err) {
        console.error(err);
        const tNow = uploadText[currentLang] || uploadText.en;
        statusMsg.className = "text-xs text-red-600";
        statusMsg.textContent = tNow.statusNetworkError;
      } finally {
        const tNow = uploadText[currentLang] || uploadText.en;
        submitBtn.disabled = false;
        submitBtn.textContent = tNow.buttonAdd;
      }
    });

    /*************** LANGUAGE TOGGLE EVENTS ***************/
    const uploadEnBtn = document.getElementById("uploadEnBtn");
    const uploadKhBtn = document.getElementById("uploadKhBtn");

    uploadEnBtn.addEventListener("click", () => {
      currentLang = "en";
      localStorage.setItem("vmctk_admin_lang", currentLang);
      applyUploadLanguage();
    });

    uploadKhBtn.addEventListener("click", () => {
      currentLang = "kh";
      localStorage.setItem("vmctk_admin_lang", currentLang);
      applyUploadLanguage();
    });

    // Initial load
    applyUploadLanguage();
  </script>
</body>
</html>
