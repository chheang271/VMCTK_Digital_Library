<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VMCTK Digital Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --vmc-blue: #1e40af;
      --vmc-light-blue: #3b82f6;
      --vmc-yellow: #facc15;
      --vmc-bg-light: #f3f4f6;
      --vmc-bg-dark: #111827;
      --vmc-text-light: #1f2937;
      --vmc-text-dark: #f9fafb;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--vmc-bg-light);
      color: var(--vmc-text-light);
      transition: background-color 0.6s ease, color 0.6s ease;
    }

    body.dark {
      background-color: var(--vmc-bg-dark);
      color: var(--vmc-text-dark);
    }

    /* ---------- Global helpers for dark mode ---------- */
    body.dark h3 { color: #f9fafb !important; }
    body.dark p  { color: #d1d5db !important; }
    body.dark a  { color: #93c5fd; }
    body.dark .text-blue-500 { color: #60a5fa !important; }

    /* ğŸŒ™ About + Contact contrasts */
    body.dark #aboutVMCTK h2,
    body.dark #contactSection h2 {
      color: var(--vmc-yellow) !important;
    }
    body.dark #aboutVMCTK p,
    body.dark #contactSection p {
      color: #f9fafb !important;
    }
    body.dark #aboutVMCTK strong,
    body.dark #aboutVMCTK em,
    body.dark #aboutVMCTK span {
      color: var(--vmc-yellow) !important;
    }

    /* Featured heading in dark */
    body.dark #featuredSection h2 { color: var(--vmc-yellow) !important; }

    /* Footer contrast in dark */
    body.dark footer p,
    body.dark footer a { color: var(--vmc-yellow) !important; }

    /* ---------- Loading Screen ---------- */
    #loadingScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--vmc-light-blue), var(--vmc-blue));
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 1.1rem;
      z-index: 100;
      transition: opacity 0.8s ease-out;
    }
    #loadingScreen.fade-out { opacity: 0; visibility: hidden; }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--vmc-yellow);
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ---------- Header ---------- */
    header {
      background: linear-gradient(to right, var(--vmc-light-blue), var(--vmc-blue));
      color: white;
      transition: background-color 0.6s ease;
    }
    body.dark header {
      background: linear-gradient(to right, #1e293b, var(--vmc-bg-dark));
      color: var(--vmc-yellow);
    }
    #themeToggle { font-size: 1.4rem; color: var(--vmc-yellow); }

    /* ---------- Buttons & links ---------- */
    button, a { transition: background-color 0.3s, color 0.3s, transform 0.2s; }
    button:hover, a:hover { transform: scale(1.05); }
    #enBtn { background-color: var(--vmc-blue); color: white; }
    #khBtn { background-color: var(--vmc-yellow); color: black; }
    #enBtn:hover { background-color: var(--vmc-light-blue); }
    #khBtn:hover { background-color: #fbbf24; }

    /* About the creator button */
    #aboutCreatorBtn {
      background-color: rgba(255,255,255,0.95);
      color: #1e3a8a;
    }
    body.dark #aboutCreatorBtn {
      background-color: #facc15;
      color: #111827;
    }

    /* ---------- Featured Carousel ---------- */
    #featuredSection { background: linear-gradient(to right, #e0f2fe, #fef9c3); }
    body.dark #featuredSection { background: linear-gradient(to right, #1e293b, #1f2937); }
    #featuredList {
      display: flex; gap: 1rem; overflow-x: auto;
      scroll-snap-type: x mandatory; scroll-behavior: smooth;
      padding: 0.5rem; -webkit-overflow-scrolling: touch;
    }
    #featuredList::-webkit-scrollbar { height: 6px; }
    #featuredList::-webkit-scrollbar-thumb { background: var(--vmc-yellow); border-radius: 10px; }
    .featured-card {
      flex: 0 0 85%; max-width: 300px; scroll-snap-align: center;
      border: 2px solid var(--vmc-yellow);
      background-color: rgba(250, 204, 21, 0.1);
      border-radius: 1rem; padding: 0.75rem;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .featured-card:hover { transform: scale(1.03); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    @media (min-width: 640px) { .featured-card { flex: 0 0 40%; } }
    @media (min-width: 1024px) { .featured-card { flex: 0 0 25%; } }
    .book-cover { width: 100%; height: auto; object-fit: cover; border-radius: 0.75rem; }

    /* ---------- Modal / Glass ---------- */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      justify-content: center;
      align-items: center;
      z-index: 50;
      padding: 1rem;
      overflow-y: auto;
    }
    .modal.show { display: flex; animation: fadeIn 0.4s ease forwards; }
    @keyframes fadeIn { from {opacity:0; transform:scale(0.95);} to {opacity:1; transform:scale(1);} }

    .modal-content {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 26rem;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      border: 2px solid var(--vmc-blue);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      box-sizing: border-box;
    }
    body.dark .modal-content { background: rgba(55, 65, 81, 0.85); }

    /* ---------- Dropdown ---------- */
    #categoryDropdown {
      border: 2px solid var(--vmc-blue); background-color: white;
      color: var(--vmc-text-light); font-weight: 500; transition: all 0.3s;
    }
    body.dark #categoryDropdown {
      background-color: var(--vmc-bg-dark);
      color: var(--vmc-text-dark); border-color: var(--vmc-yellow);
    }
    #categoryDropdown:hover { transform: scale(1.03); border-color: var(--vmc-light-blue); }

    /* Favorites toggle button styles */
    #favoritesToggle {
      border: 2px solid var(--vmc-blue);
      background-color: #ffffff;
      color: #111827;
      font-weight: 500;
    }
    #favoritesToggle:hover {
      background-color: #fef9c3;
      border-color: var(--vmc-yellow);
    }
    body.dark #favoritesToggle {
      background-color: var(--vmc-yellow);
      color: #111827;
      border-color: var(--vmc-yellow);
    }
    body.dark #favoritesToggle:hover {
      background-color: #facc15;
      border-color: #facc15;
    }

    /* ---------- Footer ---------- */
    footer {
      background: linear-gradient(to right, var(--vmc-blue), var(--vmc-light-blue));
      color: white; transition: background-color 0.5s ease;
    }
    body.dark footer {
      background: linear-gradient(to right, var(--vmc-bg-dark), var(--vmc-bg-dark));
      color: var(--vmc-yellow);
    }
    footer a { color: inherit; text-decoration: none; transition: color 0.3s; }
    footer a:hover { color: var(--vmc-yellow); }

    /* ---------- FINAL OVERRIDES: black titles & authors on cards in dark mode ---------- */
    body.dark #bookList h3,
    body.dark #featuredList h3 {
      color: #111827 !important;
      text-shadow: none !important;
    }
    body.dark #bookList p:not(.text-blue-500),
    body.dark #featuredList p:not(.text-blue-500) {
      color: #111827 !important;
    }
    body.dark #bookList .text-blue-500,
    body.dark #featuredList .text-blue-500 {
      color: #60a5fa !important;
    }

    /* ---------- Dark mode fixes for selects (rating / category) ---------- */
    body.dark #feedbackRating,
    body.dark #feedbackRating option {
      background-color: #111827;
      color: #f9fafb;
    }

    body.dark #categoryDropdown,
    body.dark #categoryDropdown option {
      background-color: #111827;
      color: #f9fafb;
    }

    /* ---------- Dark mode fixes for feedback inputs ---------- */
    body.dark #feedbackComment,
    body.dark #feedbackName {
      background-color: #111827;
      color: #f9fafb;
      border-color: #e5e7eb;
    }

    body.dark #feedbackComment::placeholder,
    body.dark #feedbackName::placeholder {
      color: #9ca3af;
    }

    /* ---------- Favorite button on each card ---------- */
    .favorite-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      font-size: 1.25rem;
      line-height: 1;
      background: transparent;
      border: none;
      cursor: pointer;
      color: #9ca3af;
      transition: transform 0.2s, color 0.2s;
    }
    .favorite-btn:hover {
      transform: scale(1.15);
      color: #f97316;
    }
    .favorite-btn.favorited {
      color: #ef4444;
    }
    body.dark .favorite-btn {
      color: #9ca3af;
    }
    body.dark .favorite-btn.favorited {
      color: #fb7185;
    }

    /* ---------- Search suggestions dropdown ---------- */
    #searchSuggestions {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 25px rgba(0,0,0,0.18);
    }
    body.dark #searchSuggestions {
      background-color: #111827;
      border-color: #4b5563;
    }
  </style>
</head>

<body>
  <!-- Loading -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <p>ğŸ“š Loading VMCTK Digital Library...</p>
    <p id="quoteText" class="mt-3 text-sm italic opacity-90"></p>
  </div>

  <!-- Header -->
  <header class="shadow p-4 flex flex-col items-center relative">
    <button id="themeToggle" class="absolute top-4 right-4">ğŸŒ™</button>
    <img id="logoImage" src="LOGO VMC.png" class="w-24 mb-2" alt="VMCTK Logo">
    <h1 id="mainTitle" class="text-2xl font-bold text-center">VMCTK Digital Library</h1>
    <p id="subtitle" class="text-gray-200 dark:text-gray-300 text-center">Volunteer for My Community</p>

    <div class="mt-2 flex flex-col items-center gap-2">
      <!-- Language buttons -->
      <div class="flex gap-2">
        <button id="enBtn" class="px-3 py-1 flex items-center gap-1 rounded">
          <span>ğŸ‡¬ğŸ‡§</span><span>English</span>
        </button>
        <button id="khBtn" class="px-3 py-1 ml-2 flex items-center gap-1 rounded">
          <span>ğŸ‡°ğŸ‡­</span><span>ááŸ’á˜áŸ‚áš</span>
        </button>
      </div>

      <!-- About the Creator button -->
      <a
        href="about_creator.html"
        id="aboutCreatorBtn"
        class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs shadow hover:shadow-md"
      >
        ğŸ¨ About the Creator
      </a>
    </div>
  </header>

  <!-- Search -->
  <section class="p-4 flex justify-center">
    <div class="w-full max-w-xl relative">
      <input
        id="searchInput"
        type="text"
        placeholder="Search books..."
        class="w-full p-2 border rounded shadow bg-white text-gray-900 dark:bg-gray-800 dark:text-gray-100"
        aria-label="Search books"
        autocomplete="off"
      >
      <div
        id="searchSuggestions"
        class="absolute left-0 right-0 mt-1 bg-white dark:bg-gray-900 text-sm hidden z-20 rounded-lg"
      ></div>
      <p
        id="searchStatus"
        class="mt-1 text-xs text-center text-gray-600 dark:text-gray-300"
      ></p>
    </div>
  </section>

  <!-- Category + Favorites -->
  <section id="categorySection" class="p-4 flex justify-center">
    <div class="flex flex-wrap items-center gap-3">
      <select id="categoryDropdown" class="p-2 border rounded shadow text-gray-700 dark:text-gray-200 dark:bg-gray-800" aria-label="Filter by category">
        <option value="All">All Categories</option>
      </select>

      <button
        id="favoritesToggle"
        type="button"
        class="px-3 py-1 text-sm rounded shadow bg-white dark:bg-gray-800 dark:text-gray-200"
      >
        â­ My favorites
      </button>
    </div>
  </section>

  <!-- Featured -->
  <section id="featuredSection" class="p-4">
    <div class="flex justify-between items-center mb-3">
      <h2 id="featuredHeading" class="text-xl sm:text-2xl font-bold text-yellow-500 tracking-wide">
        â­ Featured Books
      </h2>
      <div>
        <button id="scrollLeft" class="text-yellow-400 text-2xl hover:text-yellow-300" aria-label="Scroll featured left">â—€</button>
        <button id="scrollRight" class="text-yellow-400 text-2xl hover:text-yellow-300 ml-2" aria-label="Scroll featured right">â–¶</button>
      </div>
    </div>
    <div id="featuredList"></div>
  </section>

  <!-- Book List -->
  <section id="bookList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 p-4"></section>

  <!-- Pagination -->
  <div id="pagination" class="flex flex-col items-center gap-2 pb-6 px-4"></div>

  <!-- Modal -->
  <div id="bookModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content relative">
      <button id="closeModal" class="absolute top-2 right-3 bg-red-500 text-white rounded px-2" aria-label="Close">âœ•</button>
      <img id="modalCover" src="" alt="Book Cover" class="mx-auto rounded-lg shadow">
      <h2 id="modalTitle" class="font-bold text-lg mt-2"></h2>
      <p id="modalAuthor" class="text-gray-600 mb-1"></p>
      <p id="modalLang" class="text-yellow-500 mb-1"></p>
      <p id="modalViews" class="text-xs text-gray-500 mb-3"></p>
      <p id="modalDesc" class="text-gray-700 mb-4"></p>
      <div class="flex justify-between mb-4">
        <a id="modalRead" href="#" target="_blank" rel="noopener noreferrer" class="text-green-600 font-semibold">Read Online</a>
        <a id="modalDownload" href="#" download rel="noopener" class="text-blue-600 font-semibold">Download</a>
      </div>

      <!-- Feedback section -->
      <div id="feedbackSection" class="mt-2 pt-3 border-t border-gray-200 dark:border-gray-600 text-left">
        <h3 id="feedbackHeading" class="text-sm font-semibold mb-2 text-gray-800 dark:text-gray-100">
          Feedback on this book
        </h3>
        <form id="feedbackForm" class="space-y-2">
          <div class="flex items-center gap-2">
            <label id="ratingLabel" for="feedbackRating" class="text-xs text-gray-700 dark:text-gray-300">
              Rating:
            </label>
            <select id="feedbackRating" class="border rounded px-2 py-1 text-xs dark:bg-gray-700 dark:text-gray-100 dark:border-gray-500">
              <option value="">â€“ Select â€“</option>
              <option value="1">1 â˜…</option>
              <option value="2">2 â˜…â˜…</option>
              <option value="3">3 â˜…â˜…â˜…</option>
              <option value="4">4 â˜…â˜…â˜…â˜…</option>
              <option value="5">5 â˜…â˜…â˜…â˜…â˜…</option>
            </select>
          </div>
          <textarea
            id="feedbackComment"
            rows="3"
            class="w-full border rounded p-2 text-xs resize-none dark:bg-gray-700 dark:text-gray-100 dark:border-gray-500"
            placeholder="Share your thoughts (optional)..."></textarea>
          <input
            id="feedbackName"
            type="text"
            class="w-full border rounded p-2 text-xs dark:bg-gray-700 dark:text-gray-100 dark:border-gray-500"
            placeholder="Your name (optional)">
          <button
            type="submit"
            id="feedbackSubmit"
            class="mt-1 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed">
            Submit feedback
          </button>
          <p id="feedbackStatus" class="text-xs mt-1 text-gray-600 dark:text-gray-300"></p>
        </form>
      </div>
    </div>
  </div>

  <!-- About -->
  <section id="about Library of cultivate new idea for digital age" class="px-6 py-10 bg-gradient-to-r from-blue-100 to-indigo-100 dark:from-gray-800 dark:to-gray-900 text-center">
    <img src="LOGO VMC.png" class="w-20 mx-auto mb-4 dark:hidden" alt="VMCTK Logo Light">
    <img src="LOGO_VMC_white.png" class="w-20 mx-auto mb-4 hidden dark:block" alt="VMCTK Logo Dark">
    <div id="aboutEN">
      <h2 class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-3">About Library of cultivate new idea for digital age</h2>
      <p class="max-w-2xl mx-auto text-gray-700 dark:text-gray-300 text-lg leading-relaxed">
        <strong>Library of cultivate new idea for digital age</strong> is a volunteer project by <em>Volunteer for My Community</em>,
        helping youths access <span class="text-blue-500 dark:text-blue-300 font-medium">free books</span> in
        <span class="font-semibold">English</span> & <span class="font-semibold">Khmer</span>.
      </p>
    </div>
    <div id="aboutKH" class="hidden">
      <h2 class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-3">á¢áŸ†á–á¸á–á½á€á™á¾á„</h2>
      <p class="max-w-2xl mx-auto text-gray-700 dark:text-gray-300 text-lg leading-relaxed">
        <strong>ã€Šá”ááŸ’áŠá»áŸ‡á‚áŸ†á“á·áááŸ’á˜á¸á“áŸƒá™á»á‚áŸá˜áŸá™áŒá¸á‡á¸áá›ã€‹</strong> á‚áºá‡á¶á”ááŸ’áá¶á›áŸá™áŠáŸ‚á›á–á½á€á™á¾á„á”á¶á“á”á„áŸ’á€á¾áá¡á¾á„á˜á€ áŠá¾á˜áŸ’á”á¸á‡á½á™áŸá˜áŸ’ášá½á›áŠá›áŸ‹á”áŸ’ášá‡á¶á‡á“ áŸá·áŸáŸ’áŸ á“á·áŸáŸ’áŸá·á á“áŸ…á€áŸ’á“á»á„á”áŸ’ášá‘áŸáŸá€á˜áŸ’á–á»á‡á¶á‘á¶áŸ†á„á¢áŸáŸ‹ 
        <em></em> áŠá¾á˜áŸ’á”á¸á²áŸ’á™
        <span class="text-blue-500 dark:text-blue-300 font-medium">áŠá¾á˜áŸ’á”á¸á²áŸ’á™á–á½á€á‚á¶ááŸ‹á„á¶á™áŸáŸ’ášá½á›á€áŸ’á“á»á„á€á¶ášáŸá·á€áŸ’áŸá¶áŸáŸ’ášá¶áœá‡áŸ’ášá¶áœ á“á·á„áŠá¾ášá‘á¶á“áŸ‹áŸá˜áŸá™áŸááœááŸ’áŸá‘á¸áŸ¢áŸ¡áŸ”</span>áŸ”
      </p>
    </div>
  </section>

  <!-- Contact -->
  <section id="contactSection" class="px-6 py-10 bg-gradient-to-r from-indigo-100 to-blue-100 dark:from-gray-900 dark:to-gray-800 text-center">
    <div id="contactEN">
      <h2 class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-3">ğŸ“¬ Contact Us</h2>
      <p class="text-gray-700 dark:text-gray-300 mb-6">
        Have a question, suggestion, or want to volunteer? Weâ€™d love to hear from you!
      </p>
    </div>
    <div id="contactKH" class="hidden">
      <h2 class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-3">ğŸ“¬ á‘áŸ†á“á¶á€áŸ‹á‘áŸ†á“á„á˜á€á™á¾á„</h2>
      <p class="text-gray-700 dark:text-gray-300 mb-6">
        á”áŸ’ášáŸá·á“á”á¾á›áŸ„á€á¢áŸ’á“á€á˜á¶á“áŸáŸ†áá½áš á¬á…á˜áŸ’á„á›áŸ‹á¢áŸ’áœá¸ á›áŸ„á€á¢áŸ’á“á€á¢á¶á…áŸá½ášá˜á€á€á¶á“áŸ‹á–á½á€á™á¾á„á”á¶á“áá¶á˜ášá™áŸˆemail áá¶á„á€áŸ’ášáŸ„á˜á“áŸáŸ‡áŸ” á™á¾á„ášá¸á€ášá¶á™á“á¹á„ášá„áŸ‹á…á¶áŸ†á‘á‘á½á›á™á€ášá¶á›áŸ‹á˜áá·áŸáŸ’áá¶á”á“á¶á¢áŸ†á–á¸á›áŸ„á€á¢áŸ’á“á€áŸ”
      </p>
    </div>
    <iframe
      src="https://docs.google.com/forms/d/e/1FAIpQLSe4MTbFG2ZmE-9JYGccFdh3yWlW-x7Fbck1DXAIafONQk_vUA/viewform?embedded=true"
      width="100%"
      height="600"
      frameborder="0"
      class="rounded-lg shadow-lg max-w-3xl mx-auto"></iframe>
  </section>

  <!-- Footer -->
  <footer class="text-center p-4">
    <div id="footerEN">
      <p>ğŸ“˜ Facebook: <a href="https://www.facebook.com/profile.php?id=61576745039709" target="_blank" rel="noopener noreferrer">
Youth Volunteer for My Community VMC-Prey Tob High School</a></p>
      <p>ğŸ’¬ Telegram: <a href="https://t.me/+qXdxfKmfpUVmM2E1" target="_blank" rel="noopener noreferrer">Digital Community Library ğŸ“±</a></p>
      <p>â˜ï¸ Contact: +855 96 395 8567</p>
    </div>
    <div id="footerKH" class="hidden">
      <p>ğŸ“˜ á áŸ’áœáŸáŸá”áŸŠá»á€áŸ– <a href="https://www.facebook.com/profile.php?id=61576745039709" target="_blank" rel="noopener noreferrer">á™á»áœá‡á“áŸáŸ’á˜áŸá‚áŸ’ášá…á·ááŸ’ááŠá¾á˜áŸ’á”á¸áŸá á‚á˜á“áŸááŸ’á‰á»áŸ† VMC-áœá·á‘áŸ’á™á¶á›áŸá™á–áŸ’ášáŸƒá‘á”áŸ‹ </a></p>
      <p>ğŸ’¬ ááŸá›áŸá€áŸ’ášá¶á˜áŸ– <a href="https://t.me/+qXdxfKmfpUVmM2E1" target="_blank" rel="noopener noreferrer">á”ááŸ’áá¶á›áŸá™áŸá á‚á˜á“áŸáŒá¸á‡á¸áá›ğŸ“±</a></p>
      <p>â˜ï¸ á‘áŸ†á“á¶á€áŸ‹á‘áŸ†á“á„áŸ– +855 96 395 8567</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Core config
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS75RiAFZNe61Mrh8jhMpnYX-o0XaJynvA2Ho2kfDBzrkeA1ewCftd90oZ2WDIAmeTvHX5c1uKoxIGU/pub?output=csv";
    const TRACKING_URL = "https://script.google.com/macros/s/AKfycbwah-ItVQyz8--t-qJRTFxkuzM5Yh-KQMyvcV-bcPzOZf6jU_9oWKKMurCyoUmqYBAM/exec";
    const FEEDBACK_URL = TRACKING_URL; // same endpoint

    const loadingScreen = document.getElementById("loadingScreen");
    const quoteText = document.getElementById("quoteText");
    const bookListEl = document.getElementById("bookList");
    const paginationEl = document.getElementById("pagination");

    // ----- UI translations (English / Khmer) -----
    const uiText = {
      en: {
        pageTitle: "VMCTK Digital Library",
        headerTitle: "Library of cultivate new idea for digital age",
        subtitle: "",
        searchPlaceholder: "Search books...",
        searchAll: (total) => `Showing all ${total} books`,
        searchResults: (term, count) =>
          count === 1 ? `Showing 1 book for â€œ${term}â€` : `Showing ${count} books for â€œ${term}â€`,
        allCategories: "All Categories",
        favorites: "â­ My favorites",
        favoritesOn: "â­ My favorites (ON)",
        featuredHeading: "â­ Featured Books",

        readOnline: "Read Online",
        download: "Download",

        feedbackHeading: "Feedback on this book",
        ratingLabel: "Rating:",
        feedbackPlaceholder: "Share your thoughts (optional)...",
        namePlaceholder: "Your name (optional)",
        feedbackSubmit: "Submit feedback",
        feedbackSending: "Sending feedback...",
        feedbackThanks: "Thank you for your feedback! ğŸ™",
        feedbackNeedContent: "Please add a rating or a comment.",
        feedbackNoBook: "Cannot find book information.",
        feedbackError: "Could not send feedback. Please try again later.",
        feedbackNetworkError: "Network error while sending feedback.",

        firstToRead: "Be the first to read this book!",
        readsLabel: (n) => `${n} reads`,
        paginationShowing: (start, end, total) =>
          `Showing ${start}â€“${end} of ${total} books`,
        noBooks: "No books found."
      },
      kh: {
        pageTitle: "á”ááŸ’áá¶á›áŸá™áŒá¸á‡á¸áá› VMCTK",
        headerTitle: "á”ááŸ’áŠá»áŸ‡á‚áŸ†á“á·áááŸ’á˜á¸â€‹á“áŸƒá™á»á‚áŸá˜áŸá™áŒá¸á‡á¸áá›",
        subtitle: "",
        searchPlaceholder: "áŸáŸ’áœáŸ‚á„ášá€áŸáŸ€áœá—áŸ…...",
        searchAll: (total) => `áŸáŸ€áœá—áŸ…áŸášá»á” ${total} á€áŸ’á”á¶á›`,
        searchResults: (term, count) =>
          count === 1
            ? `á”á„áŸ’á á¶á‰áŸáŸ€áœá—áŸ… 1 á€áŸ’á”á¶á› áŸá˜áŸ’ášá¶á”áŸ‹ â€œ${term}â€`
            : `á”á„áŸ’á á¶á‰áŸáŸ€áœá—áŸ… ${count} á€áŸ’á”á¶á› áŸá˜áŸ’ášá¶á”áŸ‹ â€œ${term}â€`,
        allCategories: "á”áŸ’ášá—áŸá‘á‘á¶áŸ†á„á¢áŸáŸ‹",
        favorites: "â­ áŸáŸ€áœá—áŸ…áŠáŸ‚á›ááŸ’á‰á»áŸ†á…á¼á›á…á·ááŸ’á",
        favoritesOn: "â­ áŸáŸ€áœá—áŸ…áŠáŸ‚á›ááŸ’á‰á»áŸ†á…á¼á›á…á·ááŸ’á (á”á¾á€)",
        featuredHeading: "â­ áŸáŸ€áœâ€‹á—áŸ…â€‹á–á·áŸáŸáŸ",

        readOnline: "á¢á¶á“á¢á“á¡á¶á‰",
        download: "á‘á¶á‰á™á€",

        feedbackHeading: "á˜áá·á™áŸ„á”á›áŸ‹á¢áŸ†á–á¸áŸáŸ€áœá—áŸ…á“áŸáŸ‡",
        ratingLabel: "áœá¶á™áá˜áŸ’á›áŸƒáŸ–",
        feedbackPlaceholder: "á”á‰áŸ’á…áŸá‰á˜áá·á™áŸ„á”á›áŸ‹ášá”áŸáŸ‹á¢áŸ’á“á€ (á‡á¶á‡á˜áŸ’ášá¾áŸ)...",
        namePlaceholder: "áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€ (á‡á¶á‡á˜áŸ’ášá¾áŸ)",
        feedbackSubmit: "á”á‰áŸ’á‡á¼á“á˜áá·á™áŸ„á”á›áŸ‹",
        feedbackSending: "á€áŸ†á–á»á„á”á‰áŸ’á‡á¼á“á˜áá·á™áŸ„á”á›áŸ‹...",
        feedbackThanks: "áŸá¼á˜á¢ášá‚á»áá…áŸ†á–áŸ„áŸ‡á˜áá·á™áŸ„á”á›áŸ‹ášá”áŸáŸ‹á¢áŸ’á“á€! ğŸ™",
        feedbackNeedContent: "áŸá¼á˜á”á“áŸ’ááŸ‚á˜á–á·á“áŸ’á‘á» á¬ á˜áá·á™áŸ„á”á›áŸ‹á˜á½á™áŸ”",
        feedbackNoBook: "ášá€á˜á·á“áƒá¾á‰á–áŸááŸŒá˜á¶á“áŸáŸ€áœá—áŸ…áŸ”",
        feedbackError: "á˜á·á“á¢á¶á…á”á‰áŸ’á‡á¼á“á˜áá·á™áŸ„á”áŸ„áŸ‡á”á¶á“á‘áŸ áŸá¼á˜á–áŸ’á™á¶á™á¶á˜á˜áŸ’áŠá„á‘áŸ€ááŸ”",
        feedbackNetworkError: "á”á‰áŸ’á á¶á”ááŸ’áŠá¶á‰á–áŸá›á”á‰áŸ’á‡á¼á“á˜áá·á™áŸ„á”á›áŸ‹áŸ”",

        firstToRead: "á¢áŸ’á“á€á‡á¶á›á¾á€áŠáŸ†á”á¼á„ áŠáŸ‚á›á¢á¶á“áŸáŸ€áœá—áŸ…á“áŸáŸ‡!",
        readsLabel: (n) => `${n} áŠá„á¢á¶á“`,
        paginationShowing: (start, end, total) =>
          `á€áŸ†á–á»á„á”á„áŸ’á á¶á‰ ${start}â€“${end} á“áŸƒáŸáŸ€áœá—áŸ…áŸášá»á” ${total} á€áŸ’á”á¶á›`,
        noBooks: "ášá€á˜á·á“áƒá¾á‰áŸáŸ€áœá—áŸ…á‘áŸáŸ”"
      }
    };

    let currentLang = localStorage.getItem("vmctk_lang") || "en";

    // Quotes per language
    const quotesByLang = {
      en: [
        "ğŸ“– A reader lives a thousand lives before he dies.",
        "ğŸŒ± Knowledge shared is knowledge multiplied.",
        "ğŸš€ The future belongs to those who learn today.",
        "ğŸ’¡ Small steps every day create big change.",
        "ğŸ¤ Sharing a book is sharing a world.",
        "ğŸŒˆ Education is the most powerful weapon to change the world.",
        "â¤ï¸ Learn not for school, but for life.",
        "ğŸ“ Reading is dreaming with open eyes."
      ],
      kh: [
        "ğŸ“š á¢áŸ’á“á€á¢á¶á“áŸáŸ€áœá—áŸ…á‚áºá‡á¶á¢áŸ’á“á€áŠá¹á€á“á¶áŸ†á“á¶á–áŸá›á¢á“á¶á‚áášá”áŸáŸ‹á™á¾á„áŸ”",
        "ğŸŒ á€á¶ášá¢á¶á“áŸáŸ€áœá—áŸ…á‡á¶á‚á“áŸ’á›á„á‘áŸ…ášá€á–á“áŸ’á›áºá“áŸƒá…áŸ†ááŸáŸ‡áŠá¹á„áŸ”",
        "ğŸ“˜ á€á»áŸ†áˆá”áŸ‹ášáŸ€á“ á–áŸ’ášáŸ„áŸ‡á–á·á—á–á›áŸ„á€á˜á·á“áˆá”áŸ‹á•áŸ’á›á¶áŸáŸ‹á”áŸ’áŠá¼ášá¡á¾á™áŸ”",
        "ğŸŒŸ áŸáŸ€áœá—áŸ…á›áŸ’á¢á˜á½á™ á¢á¶á…á•áŸ’á›á¶áŸáŸ‹á”áŸ’áŠá¼ášá‡á¸áœá·áá¢áŸ’á“á€á”á¶á“áŸ”"
      ]
    };

    function showRandomQuote() {
      function pickNext() {
        const list = quotesByLang[currentLang] || quotesByLang.en;
        if (!list || !list.length) return;
        const current = quoteText.textContent;
        let nextQ;
        do {
          nextQ = list[Math.floor(Math.random() * list.length)];
        } while (list.length > 1 && nextQ === current);
        quoteText.style.opacity = "0";
        setTimeout(() => {
          quoteText.textContent = nextQ;
          quoteText.style.opacity = "1";
        }, 500);
      }
      pickNext();
      setInterval(pickNext, 5000);
    }

    let books = [];
    let currentBookIdx = null;
    let favoritesOnly = false;
    let currentCategory = "All";
    let currentSearchTerm = "";
    let currentPage = 1;
    const BOOKS_PER_PAGE = 12;

    const FAVORITES_KEY = "vmctk_favorites";

    function getFavoriteIds() {
      try {
        return JSON.parse(localStorage.getItem(FAVORITES_KEY) || "[]").map(String);
      } catch {
        return [];
      }
    }

    function isFavorite(id) {
      const favs = getFavoriteIds();
      return favs.includes(String(id));
    }

    function setFavorite(id, fav) {
      const list = getFavoriteIds();
      const sid = String(id);
      const idx = list.indexOf(sid);
      if (fav && idx === -1) list.push(sid);
      if (!fav && idx !== -1) list.splice(idx, 1);
      localStorage.setItem(FAVORITES_KEY, JSON.stringify(list));
    }

    function updateFavoriteButton(btn, id) {
      const fav = isFavorite(id);
      btn.classList.toggle("favorited", fav);
      btn.textContent = fav ? "â¤" : "â™¡";
    }

    function updateFavoritesToggleButton() {
      const favoritesToggle = document.getElementById("favoritesToggle");
      if (!favoritesToggle) return;
      const t = uiText[currentLang] || uiText.en;

      if (favoritesOnly) {
        favoritesToggle.textContent = t.favoritesOn;
        favoritesToggle.classList.add("ring-2", "ring-yellow-400", "ring-offset-2");
      } else {
        favoritesToggle.textContent = t.favorites;
        favoritesToggle.classList.remove("ring-2", "ring-yellow-400", "ring-offset-2");
      }
    }

    function getIdFromUrl(url) {
      if (!url) return "";
      const match = url.match(/[-\w]{25,}/);
      return match ? match[0] : "";
    }

    function getHdCoverFromBook(book) {
      const link = book["Cover Link"] || book["Cover Original"];
      const id = getIdFromUrl(link);
      return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w2000` : "";
    }

    function getThumbCoverFromBook(book) {
      const link = book["Cover Link"] || book["Cover Original"];
      const id = getIdFromUrl(link);
      return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w600` : "";
    }

    // Increment view counter via Google Apps Script web app
    async function incrementViews(book) {
      const id = book.ID;
      if (!id) {
        console.warn("No ID for book:", book.Title);
        return;
      }

      try {
        const res = await fetch(TRACKING_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ id })
        });

        const data = await res.json();
        if (data.success && typeof data.views !== "undefined") {
          book.Views = data.views;

          const viewsEl = document.getElementById("modalViews");
          const titleEl = document.getElementById("modalTitle");
          const t = uiText[currentLang] || uiText.en;
          if (viewsEl && titleEl && titleEl.textContent === (book.Title || "Untitled")) {
            viewsEl.textContent = t.readsLabel(data.views);
          }
        } else {
          console.error("Tracking error:", data.error);
        }
      } catch (err) {
        console.error("Failed to increment views:", err);
      }
    }

    async function loadBooks() {
      const resp = await fetch(CSV_URL);
      const text = await resp.text();
      const parsed = Papa.parse(text, { header: true });
      books = parsed.data.filter(b => b.Title);

      // store original index on each book
      books.forEach((b, idx) => { b._idx = idx; });

      const featuredList = document.getElementById("featuredList");
      const categoryDropdown = document.getElementById("categoryDropdown");
      const favoritesToggle = document.getElementById("favoritesToggle");

      bookListEl.innerHTML = "";
      featuredList.innerHTML = "";

      const categories = [...new Set(books.map(b => b.Category?.trim()).filter(Boolean))];
      const t = uiText[currentLang] || uiText.en;
      categoryDropdown.innerHTML = `<option value="All">${t.allCategories}</option>` +
        categories.map(cat => `<option value="${cat}">${cat}</option>`).join("");

      categoryDropdown.addEventListener("change", e => {
        showBooks(e.target.value);
      });

      favoritesToggle.addEventListener("click", () => {
        favoritesOnly = !favoritesOnly;
        currentPage = 1;
        updateFavoritesToggleButton();
        renderBooks();
      });

      updateFavoritesToggleButton();

      books.forEach((b, originalIdx) => {
        if (b.Featured && b.Featured.toLowerCase() === "yes" && featuredList.childElementCount < 8) {
          const f = document.createElement("div");
          f.className = "featured-card cursor-pointer";
          f.innerHTML = `
            <img src="${getThumbCoverFromBook(b)}" loading="lazy" decoding="async" alt="Cover of ${b.Title}" class="book-cover mb-2">
            <h3 class="font-semibold truncate">${b.Title}</h3>
            <p class="text-xs text-gray-600 dark:text-gray-300 truncate">${b.Author || ""}</p>
          `;
          f.onclick = () => openModal(originalIdx);
          featuredList.appendChild(f);
        }
      });

      showBooks("All");
      loadingScreen.classList.add("fade-out");
    }

    function showBooks(category) {
      currentCategory = category;
      currentPage = 1;
      renderBooks();
    }

    function updateSearchStatus(visibleCount, totalBooks) {
      const statusEl = document.getElementById("searchStatus");
      if (!statusEl) return;
      const t = uiText[currentLang] || uiText.en;
      const term = (currentSearchTerm || "").trim();
      if (!term) {
        statusEl.textContent = t.searchAll(totalBooks);
      } else {
        statusEl.textContent = t.searchResults(term, visibleCount);
      }
    }

    function renderBooks() {
      bookListEl.innerHTML = "";

      let filtered = books.filter(
        (b) => currentCategory === "All" || (b.Category || "").trim() === currentCategory
      );

      if (favoritesOnly) {
        const favIds = getFavoriteIds();
        filtered = filtered.filter((b) => favIds.includes(String(b.ID)));
      }

      if (currentSearchTerm) {
        const term = currentSearchTerm;
        filtered = filtered.filter((b) => {
          const title = (b.Title || "").toLowerCase();
          const author = (b.Author || "").toLowerCase();
          return title.includes(term) || author.includes(term);
        });
      }

      const totalItems = filtered.length;
      const totalPages = totalItems ? Math.ceil(totalItems / BOOKS_PER_PAGE) : 0;
      const t = uiText[currentLang] || uiText.en;

      updateSearchStatus(totalItems, books.length);

      if (!totalPages) {
        bookListEl.innerHTML =
          `<p class="text-center text-gray-500 dark:text-gray-300 col-span-full">${t.noBooks}</p>`;
        renderPagination(0, 0);
        return;
      }

      if (currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * BOOKS_PER_PAGE;
      const end = start + BOOKS_PER_PAGE;
      const pageItems = filtered.slice(start, end);

      pageItems.forEach((b) => {
        const card = document.createElement("div");
        card.className =
          "relative rounded-lg shadow hover:scale-105 transition p-4 bg-white dark:bg-gray-800 cursor-pointer";

        const bookId = b.ID || b._idx;

        card.innerHTML = `
          <button class="favorite-btn" type="button" aria-label="Toggle favorite">â™¡</button>
          <img src="${getThumbCoverFromBook(b)}" loading="lazy" decoding="async" alt="Cover of ${b.Title}" class="book-cover mb-2">
          <h3 class="font-bold line-clamp-2 min-h-[2.5rem]">${b.Title}</h3>
          <p class="text-sm text-gray-500 dark:text-gray-300 truncate">${b.Author}</p>
          <p class="text-sm text-blue-500"> ${b.Language}</p>
        `;

        card.onclick = () => openModal(b._idx);
        bookListEl.appendChild(card);

        const favBtn = card.querySelector(".favorite-btn");
        updateFavoriteButton(favBtn, bookId);

        favBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          const nowFav = !isFavorite(bookId);
          setFavorite(bookId, nowFav);
          updateFavoriteButton(favBtn, bookId);

          if (nowFav && typeof TRACKING_URL !== "undefined") {
            try {
              fetch(TRACKING_URL, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                  type: "favorite",
                  id: bookId
                })
              });
            } catch (err) {
              console.error("Failed to track favorite:", err);
            }
          }
        });
      });

      renderPagination(totalPages, totalItems);
    }

    // âœ… Helper: scroll up to book section when changing page
    function goToTopOfBooks() {
      const target = document.getElementById("categorySection") || document.getElementById("bookList");
      if (!target) return;
      const offset = 170;
      const top = target.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top, behavior: "smooth" });
    }

    // ---- compact pagination (max 7 page buttons) ----
    function renderPagination(totalPages, totalItems) {
      paginationEl.innerHTML = "";
      if (!totalPages || totalPages <= 1) return;

      const startIndex = (currentPage - 1) * BOOKS_PER_PAGE + 1;
      const endIndex = Math.min(currentPage * BOOKS_PER_PAGE, totalItems);
      const t = uiText[currentLang] || uiText.en;

      const info = document.createElement("span");
      info.className = "block text-xs text-gray-600 dark:text-gray-300 text-center";
      info.textContent = t.paginationShowing(startIndex, endIndex, totalItems);

      const controls = document.createElement("div");
      controls.className = "flex flex-wrap justify-center items-center gap-1";

      const createBtn = (label, onClick, disabled = false, isActive = false) => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.className =
          "px-3 py-1 rounded text-xs border " +
          (isActive
            ? "bg-blue-600 text-white border-blue-600 font-semibold"
            : "bg-white text-gray-700 border-gray-300 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-600");
        if (disabled) {
          btn.disabled = true;
          btn.classList.add("opacity-60", "cursor-not-allowed");
        } else if (onClick) {
          btn.onclick = onClick;
        }
        return btn;
      };

      const MAX_VISIBLE_PAGES = 7;

      // First & Prev
      controls.appendChild(
        createBtn("Â« First", () => {
          if (currentPage !== 1) {
            currentPage = 1;
            renderBooks();
            goToTopOfBooks();
          }
        }, currentPage === 1)
      );
      controls.appendChild(
        createBtn("â€¹ Prev", () => {
          if (currentPage > 1) {
            currentPage--;
            renderBooks();
            goToTopOfBooks();
          }
        }, currentPage === 1)
      );

      // sliding window for page numbers
      let startPage = Math.max(1, currentPage - Math.floor(MAX_VISIBLE_PAGES / 2));
      let endPage = startPage + MAX_VISIBLE_PAGES - 1;
      if (endPage > totalPages) {
        endPage = totalPages;
        startPage = Math.max(1, endPage - MAX_VISIBLE_PAGES + 1);
      }

      for (let p = startPage; p <= endPage; p++) {
        controls.appendChild(
          createBtn(String(p), () => {
            if (currentPage !== p) {
              currentPage = p;
              renderBooks();
              goToTopOfBooks();
            }
          }, false, p === currentPage)
        );
      }

      controls.appendChild(
        createBtn("Next â€º", () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderBooks();
            goToTopOfBooks();
          }
        }, currentPage === totalPages)
      );
      controls.appendChild(
        createBtn("Last Â»", () => {
          if (currentPage !== totalPages) {
            currentPage = totalPages;
            renderBooks();
            goToTopOfBooks();
          }
        }, currentPage === totalPages)
      );

      paginationEl.appendChild(info);
      paginationEl.appendChild(controls);
    }
    // ---- END compact pagination ----

    // Modal
    const modal = document.getElementById("bookModal");
    const closeBtn = document.getElementById("closeModal");
    closeBtn.onclick = () => modal.classList.remove("show");
    window.onclick = e => { if (e.target === modal) modal.classList.remove("show"); };
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") modal.classList.remove("show");
    });

    function openModal(idx) {
      const b = books[idx];
      currentBookIdx = idx;
      const t = uiText[currentLang] || uiText.en;

      document.getElementById("modalCover").src = getHdCoverFromBook(b);
      document.getElementById("modalTitle").textContent = b.Title || "Untitled";
      document.getElementById("modalAuthor").textContent = b.Author || "Unknown author";
      document.getElementById("modalLang").textContent = b.Language || "";

      const viewsEl = document.getElementById("modalViews");
      const currentViews = Number(b.Views) || 0;
      viewsEl.textContent = currentViews
        ? t.readsLabel(currentViews)
        : t.firstToRead;

      document.getElementById("modalDesc").textContent =
        b.Description || "No description available yet.";

      const readLink = document.getElementById("modalRead");
      const dlLink = document.getElementById("modalDownload");
      const pdf = b["PDF Link"];

      readLink.textContent = t.readOnline;
      dlLink.textContent = t.download;

      readLink.onclick = null;

      if (pdf) {
        readLink.href = pdf;
        dlLink.href = pdf;
        readLink.classList.remove("pointer-events-none", "opacity-50");
        dlLink.classList.remove("pointer-events-none", "opacity-50");

        readLink.onclick = () => {
          incrementViews(b);
        };
      } else {
        readLink.href = "#";
        dlLink.href = "#";
        readLink.classList.add("pointer-events-none", "opacity-50");
        dlLink.classList.add("pointer-events-none", "opacity-50");
      }

      // reset feedback UI
      feedbackRating.value = "";
      feedbackComment.value = "";
      feedbackName.value = "";
      feedbackStatus.textContent = "";
      feedbackSubmit.disabled = false;
      feedbackSubmit.textContent = t.feedbackSubmit;

      modal.classList.add("show");
    }

    // Feedback form logic (DOM refs)
    const feedbackForm = document.getElementById("feedbackForm");
    const feedbackRating = document.getElementById("feedbackRating");
    const feedbackComment = document.getElementById("feedbackComment");
    const feedbackName = document.getElementById("feedbackName");
    const feedbackStatus = document.getElementById("feedbackStatus");
    const feedbackSubmit = document.getElementById("feedbackSubmit");

    feedbackForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const t = uiText[currentLang] || uiText.en;

      if (currentBookIdx === null || !books[currentBookIdx]) {
        feedbackStatus.textContent = t.feedbackNoBook;
        return;
      }

      const book = books[currentBookIdx];
      const rating = feedbackRating.value.trim();
      const comment = feedbackComment.value.trim();
      const name = feedbackName.value.trim();

      if (!rating && !comment) {
        feedbackStatus.textContent = t.feedbackNeedContent;
        return;
      }

      feedbackSubmit.disabled = true;
      feedbackSubmit.textContent = t.feedbackSending;
      feedbackStatus.textContent = t.feedbackSending;

      try {
        const res = await fetch(FEEDBACK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            type: "feedback",
            id: book.ID || "",
            title: book.Title || "",
            rating,
            comment,
            name,
            ua: navigator.userAgent || ""
          })
        });

        const data = await res.json().catch(() => null);

        if (res.ok && data && data.success !== false) {
          feedbackStatus.textContent = t.feedbackThanks;
          feedbackRating.value = "";
          feedbackComment.value = "";
          feedbackName.value = "";
        } else {
          feedbackStatus.textContent = t.feedbackError;
          console.error("Feedback error:", data);
        }
      } catch (err) {
        console.error("Feedback request failed:", err);
        feedbackStatus.textContent = t.feedbackNetworkError;
      } finally {
        feedbackSubmit.disabled = false;
        feedbackSubmit.textContent = t.feedbackSubmit;
      }
    });

    // Language-aware UI update
    function applyLanguage() {
      const t = uiText[currentLang] || uiText.en;

      document.title = t.pageTitle;
      const subtitleEl = document.getElementById("subtitle");
      if (subtitleEl) subtitleEl.textContent = t.subtitle;
      const mainTitleEl = document.getElementById("mainTitle");
      if (mainTitleEl) mainTitleEl.textContent = t.headerTitle;

      const searchEl = document.getElementById("searchInput");
      if (searchEl) searchEl.placeholder = t.searchPlaceholder;

      const catDropdown = document.getElementById("categoryDropdown");
      if (catDropdown && catDropdown.options.length > 0) {
        catDropdown.options[0].textContent = t.allCategories;
      }

      const fh = document.getElementById("featuredHeading");
      if (fh) fh.textContent = t.featuredHeading;

      const readLink = document.getElementById("modalRead");
      const dlLink = document.getElementById("modalDownload");
      if (readLink) readLink.textContent = t.readOnline;
      if (dlLink) dlLink.textContent = t.download;

      const fbHeading = document.getElementById("feedbackHeading");
      const ratingLabel = document.getElementById("ratingLabel");
      if (fbHeading) fbHeading.textContent = t.feedbackHeading;
      if (ratingLabel) ratingLabel.textContent = t.ratingLabel;

      if (feedbackComment) feedbackComment.placeholder = t.feedbackPlaceholder;
      if (feedbackName) feedbackName.placeholder = t.namePlaceholder;
      if (feedbackSubmit) feedbackSubmit.textContent = t.feedbackSubmit;

      updateFavoritesToggleButton();
      updateSearchStatus(books.length, books.length);
    }

    // Language toggle (EN / KH)
    document.getElementById("enBtn").onclick = () => {
      currentLang = "en";
      localStorage.setItem("vmctk_lang", currentLang);
      ["aboutEN","contactEN","footerEN"].forEach(id => document.getElementById(id).classList.remove("hidden"));
      ["aboutKH","contactKH","footerKH"].forEach(id => document.getElementById(id).classList.add("hidden"));
      applyLanguage();
      renderBooks();
    };
    document.getElementById("khBtn").onclick = () => {
      currentLang = "kh";
      localStorage.setItem("vmctk_lang", currentLang);
      ["aboutKH","contactKH","footerKH"].forEach(id => document.getElementById(id).classList.remove("hidden"));
      ["aboutEN","contactEN","footerEN"].forEach(id => document.getElementById(id).classList.add("hidden"));
      applyLanguage();
      renderBooks();
    };

    // Theme toggle
    const themeToggle = document.getElementById("themeToggle");
    const logoImage = document.getElementById("logoImage");
    themeToggle.onclick = () => {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      themeToggle.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
      logoImage.src = isDark ? "LOGO_VMC_white.png" : "LOGO VMC.png";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    };
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark");
      themeToggle.textContent = "â˜€ï¸";
      logoImage.src = "LOGO_VMC_white.png";
    }

    // ---- Featured left/right arrows: move exactly ONE card per click, no auto-scroll ----
    const featuredListEl = document.getElementById("featuredList");

    function scrollFeatured(direction) {
      if (!featuredListEl) return;
      const card = featuredListEl.querySelector(".featured-card");
      if (!card) return;

      const cardRect = card.getBoundingClientRect();
      const styles = getComputedStyle(featuredListEl);
      const gap = parseFloat(styles.columnGap || styles.gap || "16");
      const step = cardRect.width + (isNaN(gap) ? 16 : gap);

      featuredListEl.scrollBy({
        left: direction * step,
        behavior: "smooth"
      });
    }

    document.getElementById("scrollLeft").onclick = () => scrollFeatured(-1);
    document.getElementById("scrollRight").onclick = () => scrollFeatured(1);

    // ---- Search suggestions ----
    const searchInput = document.getElementById("searchInput");
    const searchSuggestionsEl = document.getElementById("searchSuggestions");

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, ch => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[ch]));
    }

    function buildSearchSuggestions(termRaw) {
      if (!searchSuggestionsEl) return;
      const term = (termRaw || "").trim().toLowerCase();
      if (!term) {
        searchSuggestionsEl.classList.add("hidden");
        searchSuggestionsEl.innerHTML = "";
        return;
      }

      const matches = [];
      const seen = new Set();

      for (const b of books) {
        const title = b.Title || "";
        const author = b.Author || "";
        const combined = (title + " " + author).toLowerCase();
        if (combined.includes(term)) {
          const key = title + "||" + author;
          if (!seen.has(key)) {
            seen.add(key);
            matches.push({ title, author });
            if (matches.length >= 8) break;
          }
        }
      }

      if (!matches.length) {
        searchSuggestionsEl.classList.add("hidden");
        searchSuggestionsEl.innerHTML = "";
        return;
      }

      searchSuggestionsEl.innerHTML = matches.map(m => `
        <button type="button" class="w-full text-left px-3 py-2 bg-white dark:bg-gray-900 hover:bg-blue-50 dark:hover:bg-gray-700 border-b last:border-b-0 border-gray-100 dark:border-gray-700">
          <span class="font-medium block truncate">${escapeHtml(m.title)}</span>
          ${m.author ? `<span class="block text-xs text-gray-500 dark:text-gray-400 truncate">${escapeHtml(m.author)}</span>` : ""}
        </button>
      `).join("");

      Array.from(searchSuggestionsEl.querySelectorAll("button")).forEach((btn, idx) => {
        const { title } = matches[idx];
        btn.addEventListener("click", () => {
          searchInput.value = title;
          currentSearchTerm = title.toLowerCase();
          currentPage = 1;
          renderBooks();
          searchSuggestionsEl.classList.add("hidden");
        });
      });

      searchSuggestionsEl.classList.remove("hidden");
    }

    if (searchInput) {
      searchInput.addEventListener("input", e => {
        currentSearchTerm = e.target.value.toLowerCase();
        currentPage = 1;
        renderBooks();
        buildSearchSuggestions(e.target.value);
      });

      searchInput.addEventListener("focus", e => {
        if (e.target.value) buildSearchSuggestions(e.target.value);
      });

      searchInput.addEventListener("blur", () => {
        setTimeout(() => {
          if (searchSuggestionsEl) searchSuggestionsEl.classList.add("hidden");
        }, 160);
      });
    }

    // Initial load
    window.onload = () => {
      if (currentLang === "kh") {
        ["aboutKH","contactKH","footerKH"].forEach(id => document.getElementById(id).classList.remove("hidden"));
        ["aboutEN","contactEN","footerEN"].forEach(id => document.getElementById(id).classList.add("hidden"));
      }
      applyLanguage();
      showRandomQuote();
      loadBooks();
    };
  </script>
</body>
</html>
