<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>VMCTK Library – Volunteer for My Community</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#1e40af" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="apple-touch-icon" href="LOGO_512.png" />
<link rel="apple-touch-startup-image" href="splash_1024x2048.png" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--blue:#1e40af;--light-blue:#3b82f6;--yellow:#facc15;--bg-light:#f3f4f6;--bg-dark:#111827;--text-light:#1f2937;--text-dark:#f9fafb}
body{font-family:'Inter',sans-serif;background:var(--bg-light);color:var(--text-light);transition:.5s}
body.dark{background:var(--bg-dark);color:var(--text-dark)}
header{background:linear-gradient(to right,var(--light-blue),var(--blue));color:#fff}
body.dark header{background:linear-gradient(to right,#1e293b,var(--bg-dark));color:var(--yellow)}
#themeToggle{font-size:1.4rem;color:var(--yellow)}
#continueReading{color:#000!important}
.book-cover{width:100%;height:260px;object-fit:cover;border-radius:.5rem}
@media(max-width:640px){.book-cover{height:220px}}
.badge-new{position:absolute;top:.4rem;left:.4rem;background:var(--yellow);color:#111;font-weight:800;font-size:.65rem;padding:.2rem .45rem;border-radius:.25rem}
#updateBanner{transition:all .5s ease;transform:translateY(100%);opacity:0}
#updateBanner.show{transform:translateY(0);opacity:1}
</style>
</head>
<body>
<div id="loadingScreen" class="fixed inset-0 flex flex-col justify-center items-center z-50 bg-gradient-to-br from-blue-500 to-blue-800 text-white">
 <div class="w-10 h-10 border-4 border-white border-t-yellow-400 rounded-full animate-spin mb-3"></div>
 <p>📚 Loading VMCTK Digital Library...</p>
</div>

<header class="shadow p-4 flex flex-col items-center relative">
 <button id="themeToggle" class="absolute top-4 right-4">🌙</button>
 <img id="logoImage" src="LOGO VMC.png" class="w-24 mb-2">
 <h1 class="text-2xl font-bold text-center">VMCTK Library – Volunteer for My Community</h1>
 <p class="text-gray-200 dark:text-gray-300 text-center">Volunteer for My Community</p>
 <div class="mt-2">
   <button id="enBtn" class="px-3 py-1 bg-blue-700 text-white rounded">English</button>
   <button id="khBtn" class="px-3 py-1 ml-2 bg-yellow-400 text-black rounded">ខ្មែរ</button>
 </div>
 <a href="#favoritesPage" id="favoritesLink" class="mt-3 text-sm text-yellow-200 dark:text-yellow-400 hover:underline">💖 View Favorite Books</a>
 <button id="installAppBtn" class="mt-2 bg-yellow-400 text-black font-semibold px-3 py-1 rounded hover:bg-yellow-300">📲 Install App</button>
</header>

<section id="continueReading" class="hidden bg-yellow-100 p-3 text-center shadow">
 <p>📖 Continue reading: <span id="continueBook" class="font-semibold"></span>
 <button id="continueBtn" class="ml-2 bg-blue-600 text-white px-3 py-1 rounded">Open</button>
 <button id="clearContinue" class="ml-2 bg-gray-200 text-black px-3 py-1 rounded">Clear</button></p>
</section>

<section class="p-4 flex justify-center">
 <input id="searchInput" type="text" placeholder="Search books..." class="w-full max-w-xl p-2 border rounded shadow">
</section>
<section class="p-4 flex justify-center">
 <select id="categoryDropdown" class="p-2 border rounded shadow"><option value="All">All Categories</option></select>
</section>

<section id="featuredSection" class="p-4">
 <h2 class="text-xl font-bold text-yellow-500 mb-3">⭐ Featured Books</h2>
 <div id="featuredList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
</section>

<section id="bookList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4"></section>

<footer class="text-center p-4">
 <p>📘 Facebook: <a href="https://www.facebook.com/profile.php?id=61576745039709" target="_blank">Volunteer for My Community</a></p>
 <p>💬 Telegram: <a href="https://t.me/+exCdScgzKltlN2Zl" target="_blank">Join VMCTK</a></p>
 <p>☎️ Contact: +855 96 998 6500</p>
</footer>

<div id="updateBanner" class="hidden fixed bottom-0 left-0 w-full bg-blue-600 text-white text-center py-3 px-4 font-medium shadow-lg flex justify-center items-center z-50">
 🔄 A new version of <strong class="mx-1">VMCTK Library</strong> is available.
 <button id="refreshAppBtn" class="ml-3 bg-yellow-400 text-black font-semibold px-3 py-1 rounded hover:bg-yellow-300">Refresh Now</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const CSV_URL="https://raw.githubusercontent.com/chheang271/VMCTK_Digital_Library/refs/heads/main/books.csv";
let books=[];

// ✅ Utility
function getHdCover(u){if(!u)return"";const m=u.match(/[-\\w]{25,}/);return m?`https://drive.google.com/thumbnail?id=${m[0]}&sz=w2000`:u;}
function isNew(d){if(!d)return!1;const t=new Date(d);return!isNaN(t)&&((Date.now()-t)/864e5<=30);}

// ✅ Load CSV + Render
async function loadBooks(){
 try{
  const res=await fetch(CSV_URL);
  const text=await res.text();
  const parsed=Papa.parse(text,{header:true});
  books=parsed.data.filter(b=>b.Title);
  renderCategories();renderBooks();renderFeatured();
  document.getElementById("loadingScreen").classList.add("hidden");
 }catch(e){console.error("Book load failed:",e);}
}

function renderCategories(){
 const d=document.getElementById("categoryDropdown");
 const cats=[...new Set(books.map(b=>(b.Category||"").trim()).filter(Boolean))];
 d.innerHTML="<option>All</option>"+cats.map(c=>`<option>${c}</option>`).join("");
 d.onchange=e=>renderBooks(e.target.value);
}

function renderBooks(cat="All"){
 const c=document.getElementById("bookList");c.innerHTML="";
 books.filter(b=>cat==="All"||b.Category===cat).forEach((b,i)=>{
  const d=document.createElement("div");
  d.className="book-card rounded-lg shadow p-4 bg-white dark:bg-gray-800 cursor-pointer relative";
  const badge=isNew(b["Date Added"])?`<span class='badge-new'>NEW</span>`:"";
  d.innerHTML=`${badge}<img src='${getHdCover(b["Cover Link"])}' class='book-cover mb-2'>
  <h3 class='font-bold'>${b.Title}</h3>
  <p class='text-sm text-gray-500'>${b.Author||""}</p>
  <p class='text-sm text-blue-500'>${b.Language||""}</p>`;
  d.addEventListener("click",()=>window.openModal(i)); // ✅ Fixed global scope call
  c.appendChild(d);
 });
}

function renderFeatured(){
 const f=document.getElementById("featuredList");f.innerHTML="";
 books.forEach((b,i)=>{
  if(b.Featured&&b.Featured.toLowerCase()==="yes"&&f.childElementCount<5){
   const badge=isNew(b["Date Added"])?`<span class='badge-new'>NEW</span>`:"";
   const c=document.createElement("div");
   c.className="cursor-pointer relative bg-white dark:bg-gray-800 p-2 rounded shadow";
   c.innerHTML=`${badge}<img src='${getHdCover(b["Cover Link"])}' class='book-cover mb-2'>
   <h3 class='font-semibold text-center text-sm'>${b.Title}</h3>`;
   c.addEventListener("click",()=>window.openModal(i)); // ✅ Fixed
   f.appendChild(c);
  }
 });
}

// ✅ Make modal globally accessible (fixes iPhone/desktop clicks)
window.openModal=function(i){
 const b=books[i];if(!b)return;
 const modal=document.createElement("div");
 modal.className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50";

 const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
 const pdfLink=b["PDF Link"];
 const readBtn=`<a href="${pdfLink}" target="_blank" class='bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded'>Read Online</a>`;
 const downloadBtn=isIOS
  ? `<a href="${pdfLink}" target="_blank" class='bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded'>Open PDF</a>`
  : `<a href="${pdfLink}" download class='bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded'>Download</a>`;

 modal.innerHTML=`
  <div class='bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-80 max-w-sm relative'>
   <button class='absolute top-2 right-3 text-red-500 text-xl font-bold' id='closeModalBtn'>✕</button>
   <img src='${getHdCover(b["Cover Link"])}' class='rounded-lg mb-3 mx-auto book-cover'>
   <h2 class='text-lg font-bold mb-1'>${b.Title}</h2>
   <p class='text-sm text-gray-500 mb-1'>${b.Author||""}</p>
   <p class='text-sm text-blue-500 mb-3'>${b.Language||""}</p>
   <p class='text-sm text-gray-600 dark:text-gray-400 mb-4'>${b.Description||""}</p>
   <div class='flex justify-between'>${readBtn}${downloadBtn}</div>
  </div>`;
 document.body.appendChild(modal);
 document.getElementById("closeModalBtn").onclick=()=>modal.remove();

 // ✅ Save continue reading
 localStorage.setItem("continue",JSON.stringify(b));
 showContinue();
};

function showContinue(){
 const b=JSON.parse(localStorage.getItem("continue")||"null");
 const bar=document.getElementById("continueReading");
 if(!b)return;
 bar.classList.remove("hidden");
 document.getElementById("continueBook").textContent=b.Title;
 document.getElementById("continueBtn").onclick=()=>window.open(b["PDF Link"],"_blank");
 document.getElementById("clearContinue").onclick=()=>{localStorage.removeItem("continue");bar.classList.add("hidden");};
}

// ✅ Search
document.getElementById("searchInput").addEventListener("input",e=>{
 const term=e.target.value.toLowerCase();
 document.querySelectorAll("#bookList h3").forEach(h=>{
  const p=h.closest("div");
  p.style.display=h.textContent.toLowerCase().includes(term)?"block":"none";
 });
});

// ✅ Dark theme toggle
const t=document.getElementById("themeToggle"),l=document.getElementById("logoImage");
t.onclick=()=>{document.body.classList.toggle("dark");
 const d=document.body.classList.contains("dark");
 t.textContent=d?"☀️":"🌙";
 l.src=d?"LOGO_VMC_white.png":"LOGO VMC.png";
 localStorage.setItem("theme",d?"dark":"light");
};
if(localStorage.getItem("theme")==="dark"){document.body.classList.add("dark");t.textContent="☀️";l.src="LOGO_VMC_white.png";}

// ✅ PWA
if("serviceWorker"in navigator)navigator.serviceWorker.register("sw.js");
navigator.serviceWorker.addEventListener("message",e=>{
 if(e.data&&e.data.type==="UPDATE_AVAILABLE"){
  const b=document.getElementById("updateBanner"),r=document.getElementById("refreshAppBtn");
  b.classList.remove("hidden");setTimeout(()=>b.classList.add("show"),100);
  r.onclick=()=>{navigator.serviceWorker.controller.postMessage({type:"SKIP_WAITING"});window.location.reload();};
 }
});

window.onload=loadBooks;
</script>
</body>
</html>
